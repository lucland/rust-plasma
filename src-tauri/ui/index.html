<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plasma Furnace Simulator</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="app-container" role="application" aria-label="Plasma Furnace Simulator">
        <!-- Skip to main content link for screen readers -->
        <a href="#main-content" class="skip-link">Skip to main content</a>
        
        <!-- Application Header -->
        <header class="app-header" role="banner">
            <h1 class="app-title">Plasma Furnace Simulator</h1>
            <div class="header-actions">
                <button id="run-simulation" class="btn btn-primary" disabled 
                        aria-describedby="run-simulation-help"
                        title="Run simulation with current parameters (Ctrl+Enter)">
                    Run Simulation
                </button>
                <div id="run-simulation-help" class="sr-only">
                    Press Ctrl+Enter to run simulation, or Escape to cancel if running
                </div>
            </div>
        </header>

        <!-- Main Application Content -->
        <main class="app-main" id="main-content" role="main">
            <!-- Parameters Panel -->
            <section class="parameters-panel" id="parameters-panel" 
                     role="region" aria-labelledby="parameters-title">
                <header class="panel-header">
                    <h2 class="panel-title" id="parameters-title">Simulation Parameters</h2>
                </header>
                
                <div class="panel-content">
                    <form id="parameter-form" class="parameter-form" 
                          role="form" aria-label="Simulation parameters form">
                        <!-- Furnace Geometry -->
                        <fieldset class="parameter-group">
                            <legend class="parameter-group-title">Furnace Geometry</legend>
                            
                            <div class="form-field">
                                <label for="furnace-height" class="form-label">Height (m)</label>
                                <input 
                                    type="number" 
                                    id="furnace-height" 
                                    name="furnace-height"
                                    class="form-input"
                                    min="1.0" 
                                    max="5.0" 
                                    step="0.1" 
                                    value="2.0"
                                    required
                                    aria-describedby="furnace-height-help furnace-height-error"
                                    aria-invalid="false"
                                >
                                <span class="form-help" id="furnace-height-help">1.0 - 5.0 meters</span>
                                <div class="form-error" id="furnace-height-error" role="alert" aria-live="polite"></div>
                            </div>

                            <div class="form-field">
                                <label for="furnace-radius" class="form-label">Radius (m)</label>
                                <input 
                                    type="number" 
                                    id="furnace-radius" 
                                    name="furnace-radius"
                                    class="form-input"
                                    min="0.5" 
                                    max="2.0" 
                                    step="0.1" 
                                    value="1.0"
                                    required
                                    aria-describedby="furnace-radius-help furnace-radius-error"
                                    aria-invalid="false"
                                >
                                <span class="form-help" id="furnace-radius-help">0.5 - 2.0 meters</span>
                                <div class="form-error" id="furnace-radius-error" role="alert" aria-live="polite"></div>
                            </div>
                        </fieldset>

                        <!-- Torch Parameters -->
                        <fieldset class="parameter-group">
                            <legend class="parameter-group-title">Plasma Torch</legend>
                            
                            <div class="form-field">
                                <label for="torch-power" class="form-label">Power (kW)</label>
                                <input 
                                    type="number" 
                                    id="torch-power" 
                                    name="torch-power"
                                    class="form-input"
                                    min="50" 
                                    max="300" 
                                    step="1" 
                                    value="150"
                                    required
                                >
                                <span class="form-help">50 - 300 kW</span>
                                <div class="form-error" id="torch-power-error"></div>
                            </div>

                            <div class="form-field-group">
                                <div class="form-field">
                                    <label for="torch-position-r" class="form-label">Position R (m)</label>
                                    <input 
                                        type="number" 
                                        id="torch-position-r" 
                                        name="torch-position-r"
                                        class="form-input"
                                        min="0" 
                                        max="2.0" 
                                        step="0.1" 
                                        value="0.0"
                                        required
                                    >
                                    <div class="form-error" id="torch-position-r-error"></div>
                                </div>

                                <div class="form-field">
                                    <label for="torch-position-z" class="form-label">Position Z (m)</label>
                                    <input 
                                        type="number" 
                                        id="torch-position-z" 
                                        name="torch-position-z"
                                        class="form-input"
                                        min="0" 
                                        max="5.0" 
                                        step="0.1" 
                                        value="1.0"
                                        required
                                    >
                                    <div class="form-error" id="torch-position-z-error"></div>
                                </div>
                            </div>

                            <div class="form-field">
                                <label for="torch-efficiency" class="form-label">Efficiency</label>
                                <input 
                                    type="number" 
                                    id="torch-efficiency" 
                                    name="torch-efficiency"
                                    class="form-input"
                                    min="0.7" 
                                    max="0.9" 
                                    step="0.01" 
                                    value="0.8"
                                    required
                                >
                                <span class="form-help">0.7 - 0.9</span>
                                <div class="form-error" id="torch-efficiency-error"></div>
                            </div>
                        </fieldset>

                        <!-- Material Selection -->
                        <fieldset class="parameter-group">
                            <legend class="parameter-group-title">Material</legend>
                            
                            <div class="form-field">
                                <label for="material-type" class="form-label">Material Type</label>
                                <select id="material-type" name="material-type" class="form-select" required
                                        aria-describedby="material-type-error"
                                        aria-invalid="false">
                                    <option value="Steel">Steel</option>
                                    <option value="Aluminum">Aluminum</option>
                                    <option value="Concrete">Concrete</option>
                                </select>
                                <div class="form-error" id="material-type-error" role="alert" aria-live="polite"></div>
                            </div>
                        </fieldset>

                        <!-- Simulation Settings -->
                        <fieldset class="parameter-group">
                            <legend class="parameter-group-title">Simulation Settings</legend>
                            
                            <div class="form-field">
                                <label for="simulation-duration" class="form-label">Duration (s)</label>
                                <input 
                                    type="number" 
                                    id="simulation-duration" 
                                    name="simulation-duration"
                                    class="form-input"
                                    min="10" 
                                    max="300" 
                                    step="1" 
                                    value="60"
                                    required
                                >
                                <span class="form-help">10 - 300 seconds</span>
                                <div class="form-error" id="simulation-duration-error"></div>
                            </div>

                            <div class="form-field">
                                <label for="simulation-timestep" class="form-label">Time Step (s)</label>
                                <input 
                                    type="number" 
                                    id="simulation-timestep" 
                                    name="simulation-timestep"
                                    class="form-input"
                                    min="0.1" 
                                    max="1.0" 
                                    step="0.1" 
                                    value="0.5"
                                    required
                                >
                                <span class="form-help">0.1 - 1.0 seconds</span>
                                <div class="form-error" id="simulation-timestep-error"></div>
                            </div>
                        </fieldset>

                        <!-- Advanced Settings (for testing scrolling) -->
                        <fieldset class="parameter-group">
                            <legend class="parameter-group-title">Advanced Settings</legend>
                            
                            <div class="form-field">
                                <label for="mesh-resolution" class="form-label">Mesh Resolution</label>
                                <select id="mesh-resolution" name="mesh-resolution" class="form-select">
                                    <option value="coarse">Coarse (Fast)</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="fine">Fine (Accurate)</option>
                                    <option value="ultra">Ultra (Slow)</option>
                                </select>
                                <span class="form-help">Higher resolution = more accurate but slower</span>
                                <div class="form-error" id="mesh-resolution-error"></div>
                            </div>

                            <div class="form-field">
                                <label for="convergence-tolerance" class="form-label">Convergence Tolerance</label>
                                <input 
                                    type="number" 
                                    id="convergence-tolerance" 
                                    name="convergence-tolerance"
                                    class="form-input"
                                    min="1e-6" 
                                    max="1e-3" 
                                    step="1e-6" 
                                    value="1e-4"
                                >
                                <span class="form-help">1e-6 to 1e-3</span>
                                <div class="form-error" id="convergence-tolerance-error"></div>
                            </div>

                            <div class="form-field">
                                <label for="max-iterations" class="form-label">Max Iterations</label>
                                <input 
                                    type="number" 
                                    id="max-iterations" 
                                    name="max-iterations"
                                    class="form-input"
                                    min="100" 
                                    max="10000" 
                                    step="100" 
                                    value="1000"
                                >
                                <span class="form-help">100 - 10000 iterations</span>
                                <div class="form-error" id="max-iterations-error"></div>
                            </div>
                        </fieldset>

                        <!-- Output Settings -->
                        <fieldset class="parameter-group">
                            <legend class="parameter-group-title">Output Settings</legend>
                            
                            <div class="form-field">
                                <label for="output-frequency" class="form-label">Output Frequency (steps)</label>
                                <input 
                                    type="number" 
                                    id="output-frequency" 
                                    name="output-frequency"
                                    class="form-input"
                                    min="1" 
                                    max="100" 
                                    step="1" 
                                    value="10"
                                >
                                <span class="form-help">Save results every N time steps</span>
                                <div class="form-error" id="output-frequency-error"></div>
                            </div>

                            <div class="form-field">
                                <label for="export-format" class="form-label">Export Format</label>
                                <select id="export-format" name="export-format" class="form-select">
                                    <option value="csv">CSV (Spreadsheet)</option>
                                    <option value="json" selected>JSON (Data)</option>
                                    <option value="vtk">VTK (Visualization)</option>
                                </select>
                                <div class="form-error" id="export-format-error"></div>
                            </div>

                            <div class="form-field">
                                <label for="include-metadata" class="form-label">Include Metadata</label>
                                <select id="include-metadata" name="include-metadata" class="form-select">
                                    <option value="true" selected>Yes</option>
                                    <option value="false">No</option>
                                </select>
                                <span class="form-help">Include simulation parameters in output</span>
                                <div class="form-error" id="include-metadata-error"></div>
                            </div>
                        </fieldset>
                    </form>

                    <!-- Parameter Validation Status -->
                    <div class="parameter-status" id="parameter-status">
                        <span class="status-text">Ready to configure parameters</span>
                    </div>
                </div>
            </section>

            <!-- Visualization Panel -->
            <section class="visualization-panel" id="visualization-panel" 
                     role="region" aria-labelledby="visualization-title">
                <header class="panel-header">
                    <h2 class="panel-title" id="visualization-title">3D Temperature Visualization</h2>
                    <div class="panel-actions">
                        <button id="reset-camera" class="btn btn-secondary" disabled
                                title="Reset camera to default view (R key)"
                                aria-label="Reset camera view">
                            Reset View
                        </button>
                    </div>
                </header>

                <div class="panel-content">
                    <!-- Simulation Controls -->
                    <div class="simulation-controls" id="simulation-controls" style="display: none;">
                        <div class="progress-section">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progress-percentage">0%</span>
                                <span id="progress-time">Estimated: --</span>
                            </div>
                        </div>
                        
                        <div class="control-actions">
                            <button id="cancel-simulation" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>

                    <!-- Animation Controls -->
                    <div class="animation-controls" id="animation-controls" style="display: none;"
                         role="region" aria-labelledby="animation-controls-title">
                        <h3 id="animation-controls-title" class="sr-only">Animation Controls</h3>
                        
                        <div class="playback-controls" role="group" aria-label="Playback controls">
                            <button id="play-pause" class="btn btn-primary"
                                    title="Play/Pause animation (Spacebar)"
                                    aria-label="Play or pause animation">
                                <span id="play-pause-icon" aria-hidden="true">‚ñ∂</span>
                            </button>
                            <button id="step-backward" class="btn btn-secondary"
                                    title="Step backward (Left arrow)"
                                    aria-label="Step backward one frame">
                                <span aria-hidden="true">‚èÆ</span>
                            </button>
                            <button id="step-forward" class="btn btn-secondary"
                                    title="Step forward (Right arrow)"
                                    aria-label="Step forward one frame">
                                <span aria-hidden="true">‚è≠</span>
                            </button>
                        </div>

                        <div class="time-controls" role="group" aria-label="Time navigation">
                            <input 
                                type="range" 
                                id="time-slider" 
                                class="time-slider"
                                min="0" 
                                max="100" 
                                value="0"
                                disabled
                                aria-label="Animation time position"
                                aria-describedby="time-display-help"
                            >
                            <div class="time-display" id="time-display-help">
                                <span id="current-time" aria-label="Current time">0.0s</span>
                                <span id="total-time" aria-label="Total time">60.0s</span>
                            </div>
                        </div>

                        <div class="speed-controls" role="group" aria-label="Animation speed">
                            <label for="animation-speed" class="form-label">Speed:</label>
                            <select id="animation-speed" class="form-select"
                                    aria-label="Animation playback speed">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1x</option>
                                <option value="2">2x</option>
                                <option value="4">4x</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3D Visualization Container -->
                    <div class="visualization-container" id="visualization-container"
                         role="img" aria-labelledby="visualization-status"
                         tabindex="0" aria-describedby="visualization-help">
                        <canvas id="visualization-canvas" 
                                aria-label="3D temperature visualization"
                                role="img"></canvas>
                        
                        <div id="visualization-help" class="sr-only">
                            Use mouse to rotate view, scroll to zoom, drag to pan. Press R to reset camera.
                        </div>
                        
                        <!-- Placeholder State -->
                        <div class="visualization-placeholder" id="visualization-placeholder">
                            <div class="placeholder-content">
                                <div class="placeholder-icon" aria-hidden="true">üî•</div>
                                <h3 class="placeholder-title">3D Heat Visualization</h3>
                                <p class="placeholder-text">Configure parameters and run simulation to see temperature distribution</p>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div class="visualization-loading" id="visualization-loading" style="display: none;">
                            <div class="loading-content">
                                <div class="loading-spinner"></div>
                                <p class="loading-text">Loading visualization...</p>
                            </div>
                        </div>

                        <!-- Error State -->
                        <div class="visualization-error" id="visualization-error" style="display: none;">
                            <div class="error-content">
                                <div class="error-icon">‚ö†Ô∏è</div>
                                <h3 class="error-title">Visualization Error</h3>
                                <p class="error-text" id="error-message">Failed to load visualization</p>
                                <button id="retry-visualization" class="btn btn-primary">Retry</button>
                            </div>
                        </div>

                        <!-- Temperature Legend -->
                        <div class="temperature-legend" id="temperature-legend" style="display: none;">
                            <div class="legend-title">Temperature (K)</div>
                            <div class="legend-gradient"></div>
                            <div class="legend-labels">
                                <span class="legend-max" id="legend-max">1000</span>
                                <span class="legend-min" id="legend-min">300</span>
                            </div>
                        </div>

                        <!-- Hover Info -->
                        <div class="hover-info" id="hover-info" style="display: none;">
                            <div class="hover-temperature">Temperature: <span id="hover-temp">--</span>K</div>
                            <div class="hover-position">Position: (<span id="hover-r">--</span>, <span id="hover-z">--</span>)</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Application Footer -->
        <footer class="app-footer" role="contentinfo">
            <div class="status-bar">
                <span id="app-status" aria-live="polite">Ready</span>
                <span class="keyboard-hint">Press F1 for keyboard shortcuts</span>
                <span class="app-version">Plasma Furnace Simulator v2.0</span>
            </div>
        </footer>
        
        <!-- Live region for status announcements -->
        <div id="status-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </div>

    <!-- Three.js for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Core system scripts (load in order) -->
    <script src="js/core/eventBus.js"></script>
    <script src="js/core/errorHandler.js"></script>
    <script src="js/core/loadingManager.js"></script>
    <script src="js/core/keyboardHandler.js"></script>
    <script src="js/core/state.js"></script>
    <script src="js/core/app.js"></script>
    
    <!-- Data models -->
    <script src="js/models/parameters.js"></script>
    
    <!-- Components -->
    <script src="js/components/errorDisplay.js"></script>
    <script src="js/components/parameters.js"></script>
    <script src="js/components/simulation.js"></script>
    <script src="js/components/visualization.js"></script>
    <script src="js/components/animation.js"></script>
    <script src="js/components/animationUI.js"></script>
    
    <!-- Main application script -->
    <script src="js/main.js"></script>
    
    <!-- Immediate test script to verify JavaScript is working -->
    <script>
        console.log('üß™ [TEST] JavaScript is working! Page loaded at:', new Date().toISOString());
        console.log('üß™ [TEST] User Agent:', navigator.userAgent);
        console.log('üß™ [TEST] Window size:', window.innerWidth, 'x', window.innerHeight);
        
        // Send initial test log to Rust terminal if Tauri is available
        if (window.__TAURI__) {
            window.__TAURI__.core.invoke('log_frontend_message', {
                level: 'info',
                component: 'TEST',
                message: 'JavaScript loaded and Tauri API is available!'
            }).catch(err => console.error('Failed to log to Rust:', err));
        } else {
            console.log('üß™ [TEST] Tauri API not available (running in browser?)');
        }
        
        // Test if our classes are available
        setTimeout(() => {
            console.log('üß™ [TEST] Class availability check:');
            const classCheck = {
                EventBus: typeof EventBus !== 'undefined',
                App: typeof App !== 'undefined',
                SimulationParameters: typeof SimulationParameters !== 'undefined',
                ParameterPanel: typeof ParameterPanel !== 'undefined',
                SimulationController: typeof SimulationController !== 'undefined',
                VisualizationPanel: typeof VisualizationPanel !== 'undefined',
                THREE: typeof THREE !== 'undefined'
            };
            
            console.log('üß™ [TEST] Classes:', classCheck);
            
            // Send class availability to Rust terminal
            if (window.__TAURI__) {
                const availableClasses = Object.entries(classCheck)
                    .filter(([name, available]) => available)
                    .map(([name]) => name);
                const missingClasses = Object.entries(classCheck)
                    .filter(([name, available]) => !available)
                    .map(([name]) => name);
                
                window.__TAURI__.core.invoke('log_frontend_message', {
                    level: 'info',
                    component: 'TEST',
                    message: `Classes available: ${availableClasses.join(', ')}`
                });
                
                if (missingClasses.length > 0) {
                    window.__TAURI__.core.invoke('log_frontend_message', {
                        level: 'warn',
                        component: 'TEST',
                        message: `Classes missing: ${missingClasses.join(', ')}`
                    });
                }
            }
            
            // Test if PlasmaSimulator global is available
            if (typeof window.PlasmaSimulator !== 'undefined') {
                console.log('üß™ [TEST] PlasmaSimulator global available');
                console.log('üß™ [TEST] Debug info function available:', typeof window.PlasmaSimulator.logDebugInfo === 'function');
                
                if (window.__TAURI__) {
                    window.__TAURI__.core.invoke('log_frontend_message', {
                        level: 'info',
                        component: 'TEST',
                        message: 'PlasmaSimulator global object is available with debug functions'
                    });
                }
            } else {
                console.log('üß™ [TEST] PlasmaSimulator global not yet available');
                
                if (window.__TAURI__) {
                    window.__TAURI__.core.invoke('log_frontend_message', {
                        level: 'warn',
                        component: 'TEST',
                        message: 'PlasmaSimulator global object not yet available'
                    });
                }
            }
        }, 1000);
    </script>
</body>
</html>