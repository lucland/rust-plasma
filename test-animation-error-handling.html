<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation Error Handling Test</title>
    <link rel="stylesheet" href="src-tauri/ui/css/main.css">
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-bottom: 15px;
            color: #333;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .test-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn.danger {
            background: #dc3545;
        }
        .test-btn.danger:hover {
            background: #c82333;
        }
        .test-btn.warning {
            background: #ffc107;
            color: #333;
        }
        .test-btn.warning:hover {
            background: #e0a800;
        }
        #animation-controls {
            min-height: 200px;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 20px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Animation Error Handling Test</h1>
        
        <div class="test-section">
            <h2>Error Scenarios</h2>
            <div class="test-buttons">
                <button class="test-btn danger" onclick="testBackendError()">Backend Unavailable</button>
                <button class="test-btn danger" onclick="testFrameLoadError()">Frame Load Error</button>
                <button class="test-btn danger" onclick="testInitializationError()">Initialization Error</button>
                <button class="test-btn warning" onclick="testRetryLogic()">Test Retry Logic</button>
                <button class="test-btn warning" onclick="testPerformanceWarning()">Performance Warning</button>
                <button class="test-btn" onclick="testCacheError()">Cache Error</button>
            </div>
            <div class="status" id="status">Ready to test...</div>
        </div>

        <div class="test-section">
            <h2>Animation Controls</h2>
            <div id="animation-controls"></div>
        </div>

        <div class="test-section">
            <h2>Recovery Actions</h2>
            <div class="test-buttons">
                <button class="test-btn" onclick="testRetryFrame()">Retry Single Frame</button>
                <button class="test-btn" onclick="testRetryAll()">Retry All Failed</button>
                <button class="test-btn" onclick="clearErrors()">Clear Errors</button>
                <button class="test-btn" onclick="enableControls()">Enable Controls</button>
            </div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="src-tauri/ui/js/core/eventBus.js"></script>
    <script src="src-tauri/ui/js/core/errorHandler.js"></script>
    <script src="src-tauri/ui/js/core/data-cache.js"></script>
    <script src="src-tauri/ui/js/components/animation.js"></script>
    <script src="src-tauri/ui/js/components/animationUI.js"></script>

    <script>
        // Initialize components
        const eventBus = new EventBus();
        const errorHandler = new ErrorHandler(eventBus);
        const dataCacheManager = new DataCacheManager(eventBus, 50);
        const animationController = new AnimationController(eventBus, dataCacheManager);
        const container = document.getElementById('animation-controls');
        const animationUI = new AnimationUI(container, animationController, eventBus, null, errorHandler);

        // Render UI
        animationUI.render();
        animationUI.show();

        // Status logger
        function logStatus(message) {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.textContent = `[${timestamp}] ${message}`;
            console.log(`[Test] ${message}`);
        }

        // Test functions
        function testBackendError() {
            logStatus('Testing backend unavailable error...');
            eventBus.emit('animation:error', {
                type: 'backend-unavailable',
                message: 'Cannot connect to simulation backend. The backend may be unavailable.',
                recoverable: true
            });
        }

        function testFrameLoadError() {
            logStatus('Testing frame load error...');
            eventBus.emit('cache:load-error', {
                timeStep: 42,
                error: 'Network timeout while loading frame data',
                retriesExhausted: true,
                attempts: 3
            });
        }

        function testInitializationError() {
            logStatus('Testing initialization error...');
            eventBus.emit('animation:error', {
                type: 'initialization',
                message: 'Failed to initialize animation: Invalid metadata received from backend',
                recoverable: false
            });
        }

        function testRetryLogic() {
            logStatus('Testing retry logic...');
            let attempt = 1;
            const maxRetries = 3;
            
            const retryInterval = setInterval(() => {
                if (attempt <= maxRetries) {
                    eventBus.emit('cache:retry', {
                        timeStep: 25,
                        attempt: attempt,
                        maxRetries: maxRetries,
                        retryDelay: 500 * Math.pow(2, attempt - 1),
                        error: 'Simulated network error'
                    });
                    attempt++;
                } else {
                    clearInterval(retryInterval);
                    logStatus('Retry logic test completed');
                }
            }, 1000);
        }

        function testPerformanceWarning() {
            logStatus('Testing performance warning...');
            animationUI.showPerformanceWarning(12.5, 30);
        }

        function testCacheError() {
            logStatus('Testing cache error...');
            eventBus.emit('cache:error', {
                type: 'initialization',
                error: 'Failed to initialize cache: Insufficient memory'
            });
        }

        function testRetryFrame() {
            logStatus('Testing retry single frame...');
            animationUI.handleRetryFrame(42).catch(err => {
                logStatus(`Retry frame failed (expected): ${err.message}`);
            });
        }

        function testRetryAll() {
            logStatus('Testing retry all failed frames...');
            animationUI.handleRetryAll().catch(err => {
                logStatus(`Retry all failed (expected): ${err.message}`);
            });
        }

        function clearErrors() {
            logStatus('Clearing errors...');
            animationUI.hideErrorNotification();
            animationUI.hidePerformanceWarning();
            animationUI.showRetryButton(false);
        }

        function enableControls() {
            logStatus('Enabling controls...');
            animationUI.enableControls(true);
        }

        // Listen to all events for debugging
        eventBus.on('animation:error', (data) => {
            console.log('[Event] animation:error', data);
        });

        eventBus.on('cache:load-error', (data) => {
            console.log('[Event] cache:load-error', data);
        });

        eventBus.on('cache:retry', (data) => {
            console.log('[Event] cache:retry', data);
        });

        eventBus.on('error:handled', (data) => {
            console.log('[Event] error:handled', data);
        });

        logStatus('Test page loaded successfully');
    </script>
</body>
</html>
